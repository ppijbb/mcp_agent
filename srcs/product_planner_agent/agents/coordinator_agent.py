"""
Coordinator Agent
Multi-Agent 간 소통, 워크플로우 조율 및 작업 협조를 관리하는 Agent
"""

from mcp_agent.agents.agent import Agent
from mcp_agent.workflows.orchestrator.orchestrator import Orchestrator
from mcp_agent.workflows.llm.augmented_llm_openai import OpenAIAugmentedLLM
from mcp_agent.workflows.llm.augmented_llm import RequestParams
from typing import Dict, List, Any
import json
import asyncio
import os
from datetime import datetime
import logging

from .figma_analyzer_agent import FigmaAnalyzerAgent
from .prd_writer_agent import PRDWriterAgent
from ..utils.status_logger import StatusLogger
from mcp_agent.log.log import logger, get_log_file_path
from mcp_agent.config import settings
from srcs.product_planner_agent.agents.business_planner_agent import BusinessPlannerAgent
from srcs.product_planner_agent.prompts.coordinator_prompts import (
    PLANNING_AND_EXECUTION_PROMPT,
    GENERATE_FINAL_REPORT_PROMPT
)


class CoordinatorAgent:
    """Agent 간 조율 및 워크플로우 관리를 위한 ReAct 기반 실행 Agent"""

    def __init__(self, orchestrator: Orchestrator, agents: Dict[str, Agent]):
        self.orchestrator = orchestrator
        self.agents = agents
        self.agent_instance = self._create_agent_instance()
        self.llm = self.orchestrator.llm_factory()
        self.status_logger = StatusLogger()
        
        # 실제 존재하는 에이전트 이름들
        self.available_agents = list(agents.keys())
        print(f"🔍 Available agents: {self.available_agents}")

        self.business_planner_agent = BusinessPlannerAgent(llm=self.llm)
        self.result = {}

    def _create_agent_instance(self) -> Agent:
        """
        조율 Agent의 기본 인스턴스 생성
        """
        instruction = self._get_base_instruction()
        return Agent(
            name="coordinator_agent",
            instruction=instruction,
            server_names=["filesystem"]
        )

    async def run(self, figma_api_key: str, figma_file_id: str, figma_node_id: str):
        logger.info("🚀 Starting Product Planner Workflow...")

        workflow_steps = [
            "Figma Design Analysis",
            "Product Requirements Document (PRD)",
            "Business Planning",
            "Final Report Generation"
        ]
        status_logger = StatusLogger(steps=workflow_steps)

        try:
            # 1. Figma 디자인 분석
            status_logger.update_status("Figma Design Analysis", "in_progress")
            figma_analysis_result = await self.figma_analyzer_agent.analyze_figma_for_prd(
                figma_api_key, figma_file_id, figma_node_id
            )
            self.result["figma_analysis"] = figma_analysis_result
            status_logger.update_status("Figma Design Analysis", "completed")
            logger.info("✅ Figma Design Analysis Completed")

            # 2. PRD 작성
            status_logger.update_status("Product Requirements Document (PRD)", "in_progress")
            prd_result = await self.prd_writer_agent.write_prd(figma_analysis_result)
            self.result["prd"] = prd_result
            status_logger.update_status("Product Requirements Document (PRD)", "completed")
            logger.info("✅ Product Requirements Document (PRD) Completed")

            # 3. 비즈니스 기획
            status_logger.update_status("Business Planning", "in_progress")
            business_plan_result = await self.business_planner_agent.create_business_plan(prd_result)
            self.result["business_plan"] = business_plan_result
            status_logger.update_status("Business Planning", "completed")
            logger.info("✅ Business Planning Completed")

            # 4. 최종 보고서 생성
            status_logger.update_status("Final Report Generation", "in_progress")
            final_report = await self.generate_final_report()
            self.result["final_report"] = final_report
            status_logger.update_status("Final Report Generation", "completed")
            logger.info("✅ Final Report Generation Completed")

            logger.info("🎉 Product Planner Workflow Completed Successfully!")
            return self.result

        except Exception as e:
            logger.error(f"💥 Workflow execution failed: {e}", exc_info=True)
            # 실패한 단계를 식별하고 상태를 'failed'로 업데이트
            current_step = next((step for step, status in status_logger.get_status().items() if status == "in_progress"), None)
            if current_step:
                status_logger.update_status(current_step, "failed")
            
            # 실패를 전파하거나 여기서 처리
            raise e

    @staticmethod
    def _get_base_instruction() -> str:
        """
        Agent의 기본 지시사항을 반환합니다.
        """
        return """
        You are the coordination maestro for a multi-agent product planning system. 
        Your role is to orchestrate a comprehensive product planning workflow that includes:
        1. Figma design analysis
        2. Product requirements documentation
        3. Business strategy planning
        4. Final integration and recommendations
        
        You work systematically through each phase, ensuring quality and completeness at each step.
        """

    @staticmethod
    def get_description() -> str:
        """Agent 설명 반환"""
        return "🎯 Multi-Agent 간 소통, 워크플로우 조율 및 작업 협조를 관리하는 중앙 조율 Agent"
    
    @staticmethod
    def get_capabilities() -> list[str]:
        """Agent 주요 기능 목록 반환"""
        return [
            "Multi-Agent 워크플로우 및 작업 순서 조율",
            "Agent 간 소통 및 정보 공유 촉진",
            "진행 상황 모니터링 및 품질 표준 보장",
            "Agent 작업 간 충돌 및 종속성 해결",
            "프로젝트 일정 및 마일스톤 조율"
        ]
    
    @staticmethod
    def get_workflow_phases() -> dict[str, dict[str, Any]]:
        """워크플로우 단계별 정보 반환"""
        return {
            "phase_1_analysis": {
                "name": "Figma Design Analysis",
                "description": "Comprehensive analysis of Figma design",
                "duration": "30 minutes"
            },
            "phase_2_prd": {
                "name": "Product Requirements Document", 
                "description": "Detailed PRD creation based on design analysis",
                "duration": "45 minutes"
            },
            "phase_3_business": {
                "name": "Business Planning",
                "description": "Strategic business plan development",
                "duration": "30 minutes"
            },
            "phase_4_integration": {
                "name": "Final Integration",
                "description": "Executive summary and recommendations",
                "duration": "15 minutes"
            }
        }
    
    @staticmethod
    def get_coordination_principles() -> list[str]:
        """조율 원칙 목록 반환"""
        return [
            "순차적 실행: 각 단계의 결과가 다음 단계의 입력이 됨",
            "품질 우선: 각 단계에서 완전한 결과물 생성",
            "오류 처리: 단계별 오류 발생 시 적절한 대응",
            "결과 통합: 모든 단계의 결과를 최종 보고서로 통합",
            "파일 저장: 최종 결과물을 지정된 경로에 저장"
        ]
    
    @staticmethod
    def get_success_metrics() -> list[str]:
        """성공 지표 목록 반환"""
        return [
            "모든 워크플로우 단계 완료",
            "각 단계별 품질 있는 결과물 생성",
            "최종 보고서 파일 저장 성공",
            "오류 발생 시 적절한 처리 및 계속 진행",
            "사용자 요구사항 충족"
        ]

    async def analyze_figma(self, figma_url: str) -> str:
        """Analyzes the Figma design."""
        prompt = f"Analyze the Figma design at this URL: {figma_url} and provide a comprehensive analysis."
        params = RequestParams(temperature=0.5)
        return await self.llm.generate_str(prompt, request_params=params)
        
    async def create_prd(self, analysis_content: str) -> str:
        """Creates a Product Requirements Document."""
        prompt = f"Based on the following analysis, create a detailed PRD:\n\n{analysis_content}"
        params = RequestParams(temperature=0.6)
        return await self.llm.generate_str(prompt, request_params=params)

    async def plan_business(self, prd_content: str) -> str:
        """Creates a business plan."""
        prompt = f"Based on the PRD, create a comprehensive business plan:\n\n{prd_content}"
        params = RequestParams(temperature=0.7)
        return await self.llm.generate_str(prompt, request_params=params)

    async def integrate_report(self, full_content: str) -> str:
        """Integrates all steps into a final report."""
        prompt = f"Synthesize the following content into a single, cohesive, and professional final report:\n\n{full_content}"
        params = RequestParams(temperature=0.7)
        return await self.llm.generate_str(prompt, request_params=params)

    async def generate_final_report(self):
        logger.info("Generating final report...")
        # ... existing code ...
        # ... new code ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
        # ...
"""
Coordinator Agent
Multi-Agent 간 소통, 워크플로우 조율 및 작업 협조를 관리하는 Agent
"""

from mcp_agent.agents.agent import Agent
from mcp_agent.workflows.orchestrator.orchestrator import Orchestrator
from mcp_agent.workflows.llm.augmented_llm_openai import OpenAIAugmentedLLM
from mcp_agent.workflows.llm.augmented_llm import RequestParams
from typing import Dict, List, Any
import json
import asyncio
import os
from datetime import datetime

from .figma_analyzer_agent import FigmaAnalyzerAgent
from .prd_writer_agent import PRDWriterAgent
from ..utils.status_logger import StatusLogger


class CoordinatorAgent:
    """Agent 간 조율 및 워크플로우 관리를 위한 ReAct 기반 실행 Agent"""

    def __init__(self, orchestrator: Orchestrator, agents: Dict[str, Agent]):
        self.orchestrator = orchestrator
        self.agents = agents
        self.agent_instance = self._create_agent_instance()
        self.llm = self.orchestrator.llm_factory()
        self.status_logger = StatusLogger()
        
        # 실제 존재하는 에이전트 이름들
        self.available_agents = list(agents.keys())
        print(f"🔍 Available agents: {self.available_agents}")

    def _create_agent_instance(self) -> Agent:
        """
        조율 Agent의 기본 인스턴스 생성
        """
        instruction = self._get_base_instruction()
        return Agent(
            name="coordinator_agent",
            instruction=instruction,
            server_names=["filesystem"]
        )

    async def run(self, initial_task: str) -> str:
        """
        간소화된 ReAct 패턴을 사용하여 제품 기획 워크플로우를 실행합니다.
        """
        print("🚀 CoordinatorAgent: ReAct 워크플로우 시작...")
        
        final_report = "## 🚀 Product Plan Final Report\n"
        
        # Define workflow steps
        steps = [
            (self.analyze_figma, "Figma Design Analysis"),
            (self.create_prd, "Product Requirements Document"),
            (self.plan_business, "Business Planning"),
        ]

        try:
            current_input = initial_task
            for i, (step_func, step_name) in enumerate(steps):
                print(f"\n📋 Step {i+1}: {step_name}")
                self.status_logger.update_status(i, "in_progress")
                
                result = await step_func(current_input)
                
                final_report += f"\n\n## {step_name}\n\n{result}"
                current_input = final_report  # Pass the accumulated report to the next step
                self.status_logger.update_status(i, "completed")
                print(f"✅ {step_name} completed")

            # Final Integration step
            print("\n🎯 Step 4: Final Integration")
            self.status_logger.update_status(3, "in_progress")
            final_report = await self.integrate_report(final_report)
            self.status_logger.update_status(3, "completed")
            print("✅ Final integration completed")

        except Exception as e:
            import traceback
            print(f"❌ 워크플로우 중 오류 발생: {e}")
            print(traceback.format_exc())
            # Mark current and subsequent steps as failed
            current_step_index = -1
            for i, s in enumerate(self.status_logger.steps):
                if s['status'] == 'in_progress':
                    current_step_index = i
                    break
            
            if current_step_index != -1:
                for i in range(current_step_index, len(self.status_logger.steps)):
                    self.status_logger.update_status(i, "failed")
            raise e

        # Save the final report
        try:
            output_dir = "product_reports"
            os.makedirs(output_dir, exist_ok=True)
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            output_path = os.path.join(output_dir, f"product_analysis_{timestamp}.md")
            
            with open(output_path, "w", encoding="utf-8") as f:
                f.write(final_report)
            
            relative_path = os.path.relpath(output_path, 'pages')
            self.status_logger.set_report_link(relative_path)
            print(f"✅ Report saved to: {output_path}")

        except Exception as e:
            print(f"❌ 파일 저장 실패: {e}")

        print("\n🎉 CoordinatorAgent: ReAct 워크플로우 완료!")
        return final_report

    @staticmethod
    def _get_base_instruction() -> str:
        """
        Agent의 기본 지시사항을 반환합니다.
        """
        return """
        You are the coordination maestro for a multi-agent product planning system. 
        Your role is to orchestrate a comprehensive product planning workflow that includes:
        1. Figma design analysis
        2. Product requirements documentation
        3. Business strategy planning
        4. Final integration and recommendations
        
        You work systematically through each phase, ensuring quality and completeness at each step.
        """

    @staticmethod
    def get_description() -> str:
        """Agent 설명 반환"""
        return "🎯 Multi-Agent 간 소통, 워크플로우 조율 및 작업 협조를 관리하는 중앙 조율 Agent"
    
    @staticmethod
    def get_capabilities() -> list[str]:
        """Agent 주요 기능 목록 반환"""
        return [
            "Multi-Agent 워크플로우 및 작업 순서 조율",
            "Agent 간 소통 및 정보 공유 촉진",
            "진행 상황 모니터링 및 품질 표준 보장",
            "Agent 작업 간 충돌 및 종속성 해결",
            "프로젝트 일정 및 마일스톤 조율"
        ]
    
    @staticmethod
    def get_workflow_phases() -> dict[str, dict[str, Any]]:
        """워크플로우 단계별 정보 반환"""
        return {
            "phase_1_analysis": {
                "name": "Figma Design Analysis",
                "description": "Comprehensive analysis of Figma design",
                "duration": "30 minutes"
            },
            "phase_2_prd": {
                "name": "Product Requirements Document", 
                "description": "Detailed PRD creation based on design analysis",
                "duration": "45 minutes"
            },
            "phase_3_business": {
                "name": "Business Planning",
                "description": "Strategic business plan development",
                "duration": "30 minutes"
            },
            "phase_4_integration": {
                "name": "Final Integration",
                "description": "Executive summary and recommendations",
                "duration": "15 minutes"
            }
        }
    
    @staticmethod
    def get_coordination_principles() -> list[str]:
        """조율 원칙 목록 반환"""
        return [
            "순차적 실행: 각 단계의 결과가 다음 단계의 입력이 됨",
            "품질 우선: 각 단계에서 완전한 결과물 생성",
            "오류 처리: 단계별 오류 발생 시 적절한 대응",
            "결과 통합: 모든 단계의 결과를 최종 보고서로 통합",
            "파일 저장: 최종 결과물을 지정된 경로에 저장"
        ]
    
    @staticmethod
    def get_success_metrics() -> list[str]:
        """성공 지표 목록 반환"""
        return [
            "모든 워크플로우 단계 완료",
            "각 단계별 품질 있는 결과물 생성",
            "최종 보고서 파일 저장 성공",
            "오류 발생 시 적절한 처리 및 계속 진행",
            "사용자 요구사항 충족"
        ]

    async def analyze_figma(self, figma_url: str) -> str:
        """Analyzes the Figma design."""
        prompt = f"Analyze the Figma design at this URL: {figma_url} and provide a comprehensive analysis."
        params = RequestParams(temperature=0.5)
        return await self.llm.generate_str(prompt, request_params=params)
        
    async def create_prd(self, analysis_content: str) -> str:
        """Creates a Product Requirements Document."""
        prompt = f"Based on the following analysis, create a detailed PRD:\n\n{analysis_content}"
        params = RequestParams(temperature=0.6)
        return await self.llm.generate_str(prompt, request_params=params)

    async def plan_business(self, prd_content: str) -> str:
        """Creates a business plan."""
        prompt = f"Based on the PRD, create a comprehensive business plan:\n\n{prd_content}"
        params = RequestParams(temperature=0.7)
        return await self.llm.generate_str(prompt, request_params=params)

    async def integrate_report(self, full_content: str) -> str:
        """Integrates all steps into a final report."""
        prompt = f"Synthesize the following content into a single, cohesive, and professional final report:\n\n{full_content}"
        params = RequestParams(temperature=0.7)
        return await self.llm.generate_str(prompt, request_params=params) 